name: CI

on:
  pull_request:

jobs:
  tests:
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-13        # intel
          # TODO: fix arm64 macos install
          # - macos-latest    # arm64
        ruby:
          - 3.1
          - 3.2
          - 3.3
          - 3.4
        test:
          - tests/fast/*
        include:
          # TODO: works on local, but fails in CI, needs to be investigated
          - os: ubuntu-latest
            ruby: 3.3
            test: tests/fail-in-ci/named_ruby_and_gemsets_comment_test.sh

          # TODO: https://github.com/rvm/rvm/issues/4937
          - os: ubuntu-latest
            ruby: 3.3
            test: tests/fail-in-ci/ruby_prepare_mount_comment_test.sh

          # TODO: Test failing on 3.4
          - os:
              - ubuntu-latest
              - macos-13        # intel
            ruby:
              - 3.1
              - 3.2
              - 3.3
            test: tests/fail-on-3.4/*

          - os:
              - ubuntu-latest
              - macos-13        # intel
            ruby: system
            test:
              # JRuby tests
              - tests/jruby/jruby_comment_test.sh
              # TruffleRuby tests
              - tests/truffleruby/truffleruby_comment_test.sh

    runs-on: ${{ matrix.os }}
    env:
      TERM: ansi
      RVM_SKIP_BREW_UPDATE: true
    steps:
      - uses: actions/checkout@v4
      - run: ./install
      - run: source ~/.rvm/scripts/rvm && rvm use ${{ matrix.ruby }} --install --default
      - run: source ~/.rvm/scripts/rvm && gem install tf -v '>=0.4.6'
      - run: source ~/.rvm/scripts/rvm && tf --text ${{ matrix.test }}

  all-passed:
    runs-on: ubuntu-latest
    if: always()
    needs:
      - tests
    steps:
      - run: exit ${{ contains(needs.*.result, 'failure') && 1 || 0 }}
